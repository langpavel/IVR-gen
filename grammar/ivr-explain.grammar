GOON
  = (_ { window = global || window; window.module = null; window.errors = []; return true; }) code:START
    {
      return {
        errors: errors,
        code: code
      };
    }

START
  = _ s:(ROOT_STATEMENT _)* { return s.map(function(x) { return x[0] }); }

ROOT_STATEMENT
  = "module" __ id:ID { return "module " + (module = id); }
  / "section" __ id:ID
    {
      if (!module) {
        errors.push("section " + id + " is not in module context");
      }
      return "enter section " + id + " in " + module + " module";
    }
  / "on" __ context:("start" / "timeout" / ("hang" "up"? {return "hangup";} ) / "invalid") { return "switch context to " + context; }
  / "on" __ context:([0-9\*#]+) { return "switch context to " + context.join(''); }
  / STATEMENT

STATEMENTS
  = s:STATEMENT+ { return s; }

STATEMENT
  = "if" _ expr:EXPR __ "then" __ th:STATEMENTS _ "else" __ els:STATEMENTS _ "endif"
    {
      return "if (" + expr + ") then (" + th + ") else (" + els + ")";
    }
  / SIMPLE_STATEMENT

SIMPLE_STATEMENT
  = "noop" __ { return; }
  / "label" __ label:ID __ { return "mark next instruction with label " + label }
  / "goto" __ "module" __ module:ID section:(_ ":" _ id:ID {return id; })? __
    {
      return "goto module " + module + (section ? " section " + section : ' root');
    }
  / "goto" __ section:ID? label:(_ ":" _ id:ID { return id; })? __
    {
      return "goto " + (section ? "section " + section : "current section") +
        (label ? " on label " + label : "");
    }
  / "gosub" __ "module" __ module:ID _ ":" _ section:ID __
    {
      return "gosub module " + module + " section " + section;
    }
  / "gosub" __ section:ID? label:(_ ":" _ id:ID { return id; })? __
    {
      return "gosub " + (section ? "section " + section : "current section") +
        (label ? " on label " + label : "");
    }
  / "include" __ path:PATH __ { return "include file at " + path }

  / "wait" __ t:TIME __ { return "wait " + t + " seconds"; }

  / ("say" __)? str:STRING __ { return "say(" + str + ")"; }


/*
  / "macro" __ ID __ ARGUMENT_LIST STATEMENT_WITH_PREFIX+ "end" (__ "macro" (__ ID)?)?
  / "sub" __ ID __ STATEMENT+ "end" (__ "sub" (__ ID)?)?
  / "goto" __ ID ( _ ":" _ ID)?
  / "say" _ (STRING _)+
  / "command" _ INTERPOLACED_STRING
  / "set"
  / "if" EXPRESSION "then" __ STATEMENT
*/


EXPR "expression"
  = "EXPR" { return "EXPR"; }


/* whitespaces */

__ = SPACE+ { return; }

_ = SPACE* { return; }

SPACE = (" " / "\n" / "\t")

TIME = sec:([0-9]+) ( _ "s" ("ec" ("ond" "s"? )? )? )? { return parseInt(sec.join('')); }

/* String nebude mit auto concatenaci */
STRING = "'" content:[^']* "'" { return content.join(''); }
/* TODO */

PATH = "PATH"
EXPR = "EXPR"
ID = first:[a-zA-Z] next:[a-zA-Z0-9]* { next.unshift(first); return next.join(''); }